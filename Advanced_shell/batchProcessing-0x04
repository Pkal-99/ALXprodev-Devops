#!/bin/bash

# List of Pokémon
pokemon_list=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

# Folder to store JSON files
mkdir -p pokemon_data

# Array to hold PIDs
pids=()

# Function to fetch Pokémon data with retry
fetch_pokemon_data() {
    name=$1
    retries=0
    max_retries=3

    while [ $retries -lt $max_retries ]; do
        if curl -s "https://pokeapi.co/api/v2/pokemon/${name,,}" -o "pokemon_data/${name}.json"; then
            echo "$name fetched successfully."
            return 0
        else
            ((retries++))
            echo "Retry $retries for $name..."
            sleep 1
        fi
    done

    echo "Failed to fetch $name after $max_retries attempts" >> error.log
}

# Start parallel processes
for name in "${pokemon_list[@]}"; do
    fetch_pokemon_data "$name" &
    pids+=($!)
done

# Wait for all background jobs and track failures
for pid in "${pids[@]}"; do
    wait "$pid" || {
        echo "Process $pid failed. Killing remaining jobs..."
        for other_pid in "${pids[@]}"; do
            kill "$other_pid" 2>/dev/null
        done
        exit 1
    }
done

echo "All Pokémon fetched successfully."